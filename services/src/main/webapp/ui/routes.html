<!DOCTYPE html>
<html>
<head>
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <link rel="stylesheet" href="css/jquery.mobile-1.4.5.css"/>
    <link rel="stylesheet" href="css/bus.css"/>
    <script src="js/gen/lib.js"></script>
    <script src="js/gen/app.js"></script>
    <script src="js/gen/template.js"></script>
    <script>
        $(document).ready(function(){
            transitionToRoutesPage();
        });
        $(document).on("pageinit","#all_routes",function(){
            transitionToRoutesPage();
        });

        function showLoading(message){

        }

        function transitionToRoutesPage(){
            $.ajax({
                type: 'GET',
                url: "/bus/services/routes",
                crossDomain: true
            }).done(function( data, textStatus, jqXHR ){
                showRoutesPage(data);
            }).fail(function( jqXHR, textStatus, errorThrown ) {
                //TODO: Failure
            });
        }

        function showRoutesPage(data){
            showPage('all_routes', 'admin/routes', {routes:data});
            $("#btn_edit_route").on('click', function(){
                hidePage('all_routes');
                showEditRoutePage({edit:true});
            });
            $("#btn_add_route").on('click', function(){
                hidePage('all_routes');
                showEditRoutePage({});
            });
        }

        function showEditRoutePage(data){
            showPage('edit_route', 'admin/editRoute', data);
            var files = [];
            $('#route_map').fileupload({
                autoUpload : false,
                replaceFileInput : false,
                change: function (e, data) {
                    files = [];
                    files.push(data.files);
                }
            });
            $("#btn_delete_route").on('click', function(){
                $.ajax({
                    type: 'DELETE',
                    url: "/bus/services/routes/" + data.id,
                    crossDomain: true
                }).done(function( data, textStatus, jqXHR ){
                    transitionToRoutesPage();
                }).fail(function( jqXHR, textStatus, errorThrown ) {
                    //TODO: Failure
                });
            });
            $("#btn_edit_route_next_step").on('click', function(){
                var url = "/bus/services/routes?"+
                        "name="+$("#route_name")[0].value +
                        "&price="+$("#route_price")[0].value +
                        "&startStation="+$("#start_station")[0].value +
                        "&startStationDesc="+$("#start_station_desc")[0].value +
                        "&endStation="+$("#end_station")[0].value +
                        "&middleStations="+$("#middle_stations")[0].value;
                $('#route_map').fileupload('send', {
                    url: url,
                    files: files
                }).done(function(data, textStatus, jqXHR){
                    files = [];
                    showEditRouteStep2(data);
                }).fail(function(jqXHR, textStatus, errorThrown){
                    files = [];
                });
            });
        }

        function showEditRouteStep2(data){
            showPage('edit_route_step2', 'admin/editRouteStep2', data);
        }

        function hidePage(targetId){
            var page = $("#"+targetId);
            page.html("");
        }

        function showPage(targetId, templateName,  data){
            var page = $("#"+targetId);
            var template = Bus[templateName];
            var content = template(data);
            page.html(content);
//            $.mobile.changePage("#"+targetId, { transition: "fade" });
//            page.enhanceWithin();
        }
    </script>
</head>

<body>
    <div data-role="page" id="all_routes">
    </div>
    <div data-role="page" id="edit_route">
    </div>
    <div data-role="page" id="edit_route_step2">
    </div>
</body>
</html>